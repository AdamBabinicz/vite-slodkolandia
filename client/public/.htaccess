# üîí Blokada listowania katalog√≥w
Options -Indexes

# üìú Kodowanie znak√≥w
AddDefaultCharset utf-8

RewriteEngine On

# üîê Przekierowanie na HTTPS (wa≈ºne, je≈õli brak certyfikatu ‚Äì nie dzia≈Ça!)
RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# üåê Przekierowanie z non-www na www (z wyjƒÖtkiem localhost)
RewriteCond %{HTTP_HOST} !^www\. [NC]
RewriteCond %{HTTP_HOST} !^localhost [NC]
RewriteRule ^ https://www.%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# üõ°Ô∏è Nag≈Ç√≥wki bezpiecze≈Ñstwa + cache
<IfModule mod_headers.c>
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set Referrer-Policy "strict-origin-when-cross-origin"

    # ‚úÖ Content-Security-Policy z 'unsafe-inline' aby dzia≈Ça≈Çy inline skrypty i eventy
    Header set Content-Security-Policy "default-src 'self'; img-src 'self' data: https:; script-src 'self' https: 'unsafe-inline'; style-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:; connect-src 'self' https:; frame-src 'self';"

    # Cache Control - trwa≈Çy cache dla zasob√≥w statycznych
    <FilesMatch "\.(ico|jpe?g|png|gif|svg|avif|webp|mp4|webm|woff2?|ttf|otf|webmanifest)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Cache dla CSS i JS
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=604800, immutable"
    </FilesMatch>

    # Cache wy≈ÇƒÖczone dla index.html
    <FilesMatch "^index\.html$">
        Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>

    Header append Vary "Accept-Encoding"
</IfModule>

# ‚è≥ Expires (mod_expires) ‚Äì domy≈õlne czasy ≈ºycia zasob√≥w
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault                              "access plus 1 month"
    ExpiresByType text/html                     "access plus 0 seconds"
    ExpiresByType application/json              "access plus 0 seconds"
    ExpiresByType application/ld+json           "access plus 0 seconds"
    ExpiresByType application/xml               "access plus 0 seconds"
    ExpiresByType text/xml                      "access plus 0 seconds"
    ExpiresByType image/vnd.microsoft.icon      "access plus 1 year"
    ExpiresByType image/x-icon                  "access plus 1 year"
    ExpiresByType image/ico                     "access plus 1 year"
    ExpiresByType image/avif                    "access plus 1 year"
    ExpiresByType image/webp                    "access plus 1 year"
    ExpiresByType image/gif                     "access plus 1 year"
    ExpiresByType image/jpeg                    "access plus 1 year"
    ExpiresByType image/png                     "access plus 1 year"
    ExpiresByType image/svg+xml                 "access plus 1 year"
    ExpiresByType video/mp4                     "access plus 1 year"
    ExpiresByType video/webm                    "access plus 1 year"
    ExpiresByType font/otf                      "access plus 1 year"
    ExpiresByType font/ttf                      "access plus 1 year"
    ExpiresByType font/woff                     "access plus 1 year"
    ExpiresByType font/woff2                    "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    ExpiresByType application/x-font-ttf        "access plus 1 year"
    ExpiresByType application/x-font-woff       "access plus 1 year"
    ExpiresByType text/css                      "access plus 1 week"
    ExpiresByType application/javascript        "access plus 1 week"
    ExpiresByType text/javascript               "access plus 1 week"
    ExpiresByType application/pdf               "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType application/manifest+json     "access plus 1 week"
</IfModule>

# üîÅ Regu≈Ça dla aplikacji SPA ‚Äì dzia≈Ça z React/Vue/Angular
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ /index.html [L]

# üí® GZIP/DEFLATE kompresja
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE font/ttf font/otf font/woff font/woff2
</IfModule>

# üì∏ Nowoczesne formaty obraz√≥w
AddType image/avif .avif
AddType image/webp .webp

# üõ°Ô∏è Blokowanie znanych z≈Çych bot√≥w
RewriteCond %{HTTP_USER_AGENT} ^BlackWidow [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^HTTrack [NC]
RewriteRule ^.* - [F,L]

# üö´ Zabezpieczenie poufnych plik√≥w
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|conf|config|cnf|sql|bak|backup|swp|~)$">
  Require all denied
</FilesMatch>
